# Улучшение навигации в разделе дефектов CSQA

**Дата:** 2026-02-19
**Область:** `src/analyzer/render_report.py` — функция `_render_html`, CSS и JS внутри генерируемого HTML-отчёта

---

## Контекст

Раздел «Дефекты» отчёта CSQA показывает плоский список карточек дефектов из всех метрик (A1–F2).
Каждый дефект содержит поля: `metric`, `severity`, `file`, `line`, `method`, `what`, `why`, `fix`.
Пользователи жалуются на отсутствие чёткой структуры и удобной сортировки.

---

## Требования

Пользователь хочет:

1. Группировку дефектов по файлу — сразу видно, какие файлы требуют внимания.
2. Сортировку файловых секций по числу дефектов (горячие точки первыми).
3. Сворачиваемые карточки — по умолчанию компактная строка, детали открываются по клику.

---

## Решение: файловые секции со сворачиваемыми карточками

### Структура данных

В `renderFindings()` дефекты сначала фильтруются (существующая логика), затем делятся
на две категории:

- дефекты с полем `file` — группируются в словарь `{ filename → [finding, ...] }`;
- дефекты без `file` (системные: B1, B2, B3 и подобные) — в отдельную секцию «Уровень системы».

Файловые секции сортируются по убыванию числа дефектов в них. Внутри каждой секции дефекты
упорядочены по серьёзности: critical → high → medium → low.

### Визуальная структура секции

```
AuthController.java  [3]   ▼
─────────────────────────────────
  ● [critical]  Пустой catch-блок                     :42
  ● [high]      Endpoint без аутентификации            :18
  ● [medium]    Высокая сложность вблизи входа (ECI)   :89
```

Заголовок секции целиком кликабелен (сворачивает/разворачивает секцию). По умолчанию развёрнут.
Имя файла отображается полным путём из поля `file`.

### Карточка дефекта

В коллапсированном состоянии — однострочное представление:
```
● [severity]  <what>   :<line>
```

Клик разворачивает inline-блок:
```
Метод: com.example.AuthController#handleRequest()
Почему: описание риска
Исправление: конкретный совет
```

Повторный клик сворачивает. Состояние хранится в `Set` (`expandedFindings`),
ключ — индекс в отфильтрованном списке. При перерендере состояние сбрасывается.

### Тулбар

Существующие фильтры (группа A–F, серьёзность) сохраняются без изменений.
Добавляется: счётчик `X из Y` становится `X из Y (critical: N, high: N, medium: N)` —
отображается как подсказка рядом со счётчиком.

---

## Технические изменения

Все изменения — только в `render_report.py` (функция `_render_html`):

| Область    | Изменение                                                              |
|------------|------------------------------------------------------------------------|
| CSS        | Новые классы: `.file-group`, `.file-group-header`, `.file-group-body`, `.finding-row`, `.finding-row-detail` |
| JavaScript | Полный переработ `renderFindings()` + новый `Set` `expandedFindings`   |
| Остальное  | `setGroupFilter`, `setSevFilter`, структура `GRAPH_DATA` — без изменений |

Обратная совместимость полная: данные `GRAPH_DATA.findings` не меняются.

---

## Граничные случаи

- Дефект без поля `file` и без поля `method` — попадает в секцию «Уровень системы», отображается
  без строки и метода.
- Все дефекты отфильтрованы — секции не рендерятся, показывается `«Дефекты не обнаружены (или отфильтрованы)»`.
- Один дефект на файл — секция из одной строки, без визуального оверхеда.

---

## Вне области этой задачи

- Поиск по тексту.
- Привязка дефекта к узлу на графе.
- Счётчики severity в кнопках тулбара (как числовые бейджи).
