# Дизайн визуализации M1: граф топологии безопасности

## Назначение

Генерация самодостаточного интерактивного HTML-файла, визуализирующего метрику M1 (граф топологии безопасности) на основе данных из `combined.json`. Файл открывается в браузере без серверной части, все данные вшиты при генерации.

## Архитектура решения

Python-скрипт `src/analyzer/render_m1.py` принимает путь к `combined.json`, извлекает данные M1 и связанных метрик, генерирует HTML-файл со встроенными стилями (из UI-kit) и JavaScript (D3.js v7 через CDN).

Выбор D3.js обусловлен тем, что force-directed раскладка наглядно отображает топологию связей между методами, а библиотека легко подключается через CDN и хорошо справляется с графами до нескольких тысяч узлов. Для проекта petclinic (163 узла, 257 ребер) это оптимально; для крупных проектов (langchain4j, 7500+ узлов) экспорт уже ограничен лимитами M1 (5000 узлов, 20000 ребер).

## Структура страницы

Страница состоит из трёх вертикальных блоков.

Первый блок — заголовок, оформленный как HUD-панель с угловыми декорациями. Содержит название репозитория, режим анализа (fast/full), хэш коммита и дату генерации.

Второй блок — сводная панель из пяти stat-карточек, расположенных горизонтально: количество узлов (методов), количество ребер (вызовов), число точек входа, число стоков и агрегированная оценка безопасности с прогресс-баром.

Третий блок — интерактивная область графа, занимающая основную часть экрана. Слева расположена панель фильтров, справа при выборе узла появляется информационная панель с деталями.

## Визуализация графа

Типы узлов различаются визуально. Обычные методы отображаются как маленькие серые точки. Точки входа (HTTP-эндпоинты, Kafka-слушатели, запланированные задачи) — крупные оранжевые точки с пульсирующей обводкой. Стоки (операции с БД, файловой системой, внешние HTTP-вызовы) — крупные красные точки. Тестовые методы — полупрозрачные маленькие точки, которые можно скрыть фильтром.

Ребра отображаются тонкими линиями приглушённого цвета. При выделении узла его соседние ребра подсвечиваются оранжевым акцентом.

Интерактивность включает масштабирование колесом мыши, перетаскивание как всего canvas, так и отдельных узлов, тултипы при наведении с коротким именем метода и информационную панель при клике с полным именем, типом узла и флагами безопасности.

Фильтры реализованы как кнопки в стиле `btn-clipped` из UI-kit: «Все», «Точки входа», «Стоки», «Скрыть тесты». При переключении фильтра граф плавно скрывает нерелевантные узлы.

## Источник данных

Скрипт читает `combined.json` и извлекает:

- `analyzer.meta` — репозиторий, режим, хэш коммита
- `analyzer.metrics.M1.export` — списки узлов и ребер
- `analyzer.metrics.M1` — счётчики (nodes, edges, entrypoints, sinks)
- `analyzer.metrics.aggregate` — агрегированная оценка и компоненты
- `analyzer.metrics.A1.sample` — детали точек входа (имя метода, наличие аутентификации, валидации)

Классификация узлов (entrypoint / sink / test / regular) выполняется на этапе генерации в Python: точки входа определяются из данных A1, стоки — из B1/B2 и паттернов имён, тестовые классы — по суффиксам `Test`/`Tests` в имени класса.

## Оформление

Используется тёмная HUD-стилистика из UI-kit: чёрный фон, оранжевый акцент (#fb923c), шрифт JetBrains Mono (подключается через CDN), угловые декорации на карточках, прогресс-бары с градиентом.
