# Интерактивный HTML-отчёт всех метрик CSA

## Контекст

Текущий модуль `render_m1.py` генерирует HTML-отчёт исключительно для метрики M1 (граф топологии безопасности). Пользователь видит пять сводных показателей (узлы, связи, точки входа, стоки, совокупная оценка) и force-directed граф с фильтрацией по типу узла. Остальные 15 числовых метрик (A1--F2) доступны только в JSON и никак не визуализируются.

Задача состоит в том, чтобы превратить одностраничный отчёт M1 в полноценный интерактивный дашборд, где все метрики представлены наглядно, а граф топологии реагирует на выбранную метрику изменением цвета, размера узлов и подсветкой связанных путей.

Побочная задача --- сделать рёбра графа более читаемыми: текущий цвет `#333` при непрозрачности 0.6 практически сливается с чёрным фоном.

## Архитектура страницы

Страница делится на общий хедер и две вкладки, переключаемые без перезагрузки.

Хедер сохраняет текущую HUD-стилистику: тёмный фон, JetBrains Mono, точки-индикаторы по углам панелей. В нём отображаются имя репозитория, режим анализа, коммит, дата генерации и совокупная оценка с прогресс-баром. Навигация между вкладками реализуется кнопками в стиле существующих `btn-clipped`.

### Вкладка «Дашборд»

Верхняя часть занята радарной (паутинной) диаграммой, построенной средствами D3.js. Оси радара соответствуют шести группам метрик: A (поверхность атаки), B (глубина защиты), C (потоки данных), D (технологические границы), E (зависимости), F (изменяемость). Значение на каждой оси --- средневзвешенное нормализованных метрик группы, что даёт мгновенное представление о профиле безопасности проекта.

Под радаром располагаются карточки-плитки всех 15 метрик, сгруппированные по категориям (A, B, C, D, E, F). Каждая карточка содержит:

- идентификатор метрики (например, A1) и краткое название (ASE);
- нормализованное значение в диапазоне [0, 1];
- мини-прогресс-бар с цветовым кодированием: зелёный при значении ниже 0.3, жёлтый при 0.3--0.7, красный выше 0.7;
- статус: ok либо not_available (для метрик, которые не удалось вычислить).

Клик по карточке переключает на вкладку «Граф» и активирует выбранную метрику в качестве оверлея.

### Вкладка «Граф»

Граф топологии сохраняет текущее поведение (D3.js force-directed, zoom, drag, пульсация точек входа, панель деталей справа, тултипы). В тулбаре добавляется выпадающий список метрик. При выборе метрики происходят три изменения:

1. Узлы окрашиваются по шкале от зелёного (#34d399) через жёлтый (#fbbf24) к красному (#f87171) пропорционально значению метрики для данного узла.
2. Размер узла масштабируется: чем выше значение метрики, тем крупнее круг.
3. Для метрик с путевой семантикой (B1, B2, C1, D2) подсвечиваются соответствующие рёбра графа.

Режим «Топология» (значение по умолчанию в списке) восстанавливает исходную раскраску по типу узла (entrypoint, sink, test, regular).

## Маппинг метрик на узлы графа

Не все метрики обладают данными в разрезе отдельных методов. Маппинг определяет, какие данные доступны для окраски узлов.

Метрики A1, A2 и A3 имеют массивы `sample` или `top` с полями `method` и числовым значением (`score`, `ECI`, `entropy`). Для этих метрик узлы, присутствующие в массиве, окрашиваются по значению; остальные узлы получают нейтральный серый цвет.

Метрики B1, B2, B3, C1, D2 описывают свойства путей в графе. Для них граф показывает стандартную топологию, но в панели деталей при выборе узла отображается общее системное значение метрики и текстовое пояснение.

Метрики B4, C2, C3, D1, E1, F1, F2 являются чисто системными (одно число на весь проект). При их выборе граф сохраняет стандартный вид, а тулбар показывает значение крупным шрифтом рядом с названием метрики.

## Видимость рёбер

Базовый цвет рёбер меняется с `#333` на `#555`, непрозрачность повышается с 0.6 до 0.8. При выделении узла связанные рёбра по-прежнему подсвечиваются акцентным цветом. Невидимые (отфильтрованные) рёбра получают непрозрачность 0.05 вместо текущих 0.03 для минимального контекста.

## Структура данных (GRAPH_DATA)

Функция `_build_graph_data()` расширяется. Помимо текущих полей (`meta`, `summary`, `nodes`, `edges`, `entrypoint_details`) добавляются:

- `all_metrics` --- словарь всех 15 метрик с нормализованными значениями, статусом и кратким названием, сгруппированный по категориям для радара;
- `metric_overlays` --- для каждой метрики с данными по узлам хранится маппинг `{ method_id: value }`;
- `aggregate` --- компоненты агрегированной оценки для радарной диаграммы.

## Переименование модуля

Файл переименовывается из `render_m1.py` в `render_report.py`. Обновляются все ссылки: Dockerfile, orchestrate.py, документация, тесты.

## Что сохраняется без изменений

Тёмная HUD-тема, шрифт JetBrains Mono, кибер-эстетика с точками в углах, пульсация точек входа, панель деталей, фильтры по типу узла, drag/zoom, самодостаточность HTML-файла (единственная внешняя зависимость --- D3.js с CDN).
