version: "3.9"

services:

  # Строит образ csqa-metrics:fast и сразу завершается.
  # Нужен только как build-цель; web зависит от его завершения.
  csqa-analyzer-init:
    build:
      context: .
      dockerfile: src/docker/Dockerfile
      target: fast
    image: csqa-metrics:fast
    restart: "no"
    entrypoint: ["sh", "-c", "exit 0"]

  web:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "${PORT:-8080}:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ${CSQA_DATA_DIR:-/var/lib/csqa}/out:/app/out
    environment:
      CSA_WEB_TOKEN: ${CSA_WEB_TOKEN:-}
      CSA_BASE_PATH: ${CSA_BASE_PATH:-/csqa-prototype}
      CSQA_HOST_OUT_DIR: ${CSQA_DATA_DIR:-/var/lib/csqa}/out
    restart: unless-stopped
    depends_on:
      csqa-analyzer-init:
        condition: service_completed_successfully
